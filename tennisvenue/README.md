# 网球场地Unity项目

## 项目概述
这是一个Unity网球模拟项目，包含网球发射器、轨迹预测和物理模拟功能。

## 项目结构
```
tennisvenue/
├── Assets/
│   ├── Materials/          # 材质文件
│   ├── Prefabs/           # 预制体
│   ├── Scenes/            # 场景文件
│   ├── Scripts/           # C#脚本
│   └── UI/               # UI资源
├── ProjectSettings/       # 项目设置
└── Packages/             # 包管理器配置
```

## 功能特点
1. **网球发射器** - BallLauncher组件控制网球发射
2. **物理模拟** - 真实的网球物理碰撞和运动
3. **轨迹预测** - TrajectoryLine显示网球飞行路径
4. **UI控制** - 角度和速度滑块控制发射参数
5. **动态摄像机** - 支持5种预设视角和实时控制
6. **🆕 飞行时间追踪** - 实时显示网球飞行时间和详细调试信息

## 🎯 核心脚本系统分析

### 📋 脚本架构概览

项目包含 **80+ 个脚本文件**，按功能可分为以下几大模块：

#### 🎾 核心功能模块
- **发射系统** (4个脚本)
- **UI管理系统** (8个脚本)
- **摄像机控制** (2个脚本)
- **物理模拟** (6个脚本)
- **视觉效果** (12个脚本)
- **测试诊断** (15个脚本)
- **🆕 飞行时间追踪** (2个脚本)

### 🔧 主要脚本详细分析

#### 1. 🚀 **BallLauncher.cs** (核心发射器)
**功能**: 网球发射系统的核心控制器
- **参数控制**: 角度(5°-60°)、速度(1-30m/s)、方向(-15°到+15°)
- **轨迹预测**: 实时显示虚线轨迹，支持障碍物检测
- **物理集成**: 集成空气阻力系统和飞行时间追踪
- **UI交互**: 自动查找和绑定UI滑块，支持快捷键控制
- **增强功能**: 支持轨迹拖拽调节参数

**关键特性**:
```csharp
// 主要控制参数
private float angle = 45f;      // 发射角度
private float speed = 20f;      // 发射速度
private float direction = 0f;   // 方向偏移

// 轨迹线设置
public float dashLength = 0.3f;   // 虚线段长度
public float gapLength = 0.15f;   // 虚线间隙
```

#### 2. 🖥️ **TennisVenueUIManager.cs** (主UI管理器)
**功能**: 统一管理所有用户界面交互
- **面板管理**: 4个功能分组面板(控制/视角/功能/调试)
- **状态管理**: 实时追踪和显示各功能模块状态
- **自动播放**: 支持定时自动发射模式
- **智能修复**: 自动检测并修复UI组件问题
- **快捷键**: F1-F3快捷键控制主要功能

**UI组织结构**:
```
主界面
├── 控制面板 (发射/重置/清理)
├── 视角控制 (6种预设视角)
├── 功能面板 (轨迹/标记/阻力等)
└── 调试面板 (状态/诊断/测试)
```

#### 3. 📷 **CameraController.cs** (摄像机控制)
**功能**: 提供多种视角和实时控制
- **预设视角**: 6种预设视角(默认/俯视/侧面/近距/全景/后场)
- **实时控制**: WASD移动，鼠标右键旋转，滚轮缩放
- **快捷切换**: R/T/F/C/V/B键快速切换视角
- **UI集成**: 自动创建视角切换按钮

**视角配置**:
```csharp
// 视角预设示例
{ name = "默认视角", position = (0, 2.5f, -5), rotation = (18°, 0°, 0°) }
{ name = "俯视角度", position = (0, 8, -2), rotation = (70°, 0°, 0°) }
{ name = "侧面视角", position = (-8, 3, 0), rotation = (15°, 90°, 0°) }
```

#### 4. 🎯 **TrajectoryDragController.cs** (轨迹拖拽控制)
**功能**: 支持通过拖拽轨迹线调节发射参数
- **交互检测**: 检测鼠标是否在轨迹线上(0.5m检测半径)
- **参数计算**: 根据目标位置反向计算发射角度和速度
- **实时更新**: 拖拽过程中实时更新轨迹线和参数
- **视觉反馈**: 高亮显示和拖拽指示器

**技术特点**:
- 使用射线投射到地面获取3D坐标
- 点到线段距离算法检测轨迹线交互
- 物理公式反向计算发射参数

#### 5. 🧹 **TennisBallCleaner.cs** (自动清理系统)
**功能**: 智能管理场景中的网球数量
- **边界检测**: 自动清理超出边界(100×50×100m)的网球
- **数量限制**: 最多保持20个网球，自动删除多余的
- **定时清理**: 每5秒执行一次清理检查
- **手动清理**: 支持一键清理所有网球

#### 6. 💥 **BounceImpactMarker.cs** (撞击标记系统)
**功能**: 在网球落地时创建视觉标记
- **落地检测**: 检测网球首次与地面接触
- **速度标记**: 圆环大小反映落地速度(0.3m-2.0m)
- **颜色分级**: 不同速度显示不同颜色(绿/黄/橙/红)
- **自动消失**: 标记15秒后自动淡出消失

**检测条件**:
```csharp
// 撞击检测条件
bool heightCondition = position.y <= 0.5f && position.y >= -1f;
bool velocityCondition = velocity.y < -0.5f;
bool speedCondition = speed > 1.5f;
```

#### 7. 🎯 **SimpleTargetMarkers.cs** (目标标记系统)
**功能**: 在场地创建编号目标标记
- **标记布局**: 2行×5列共10个圆形标记
- **数字标识**: 每个标记内显示1-10数字
- **位置配置**: 可调节标记间距和位置
- **视觉效果**: 半透明蓝色圆圈，白色数字

#### 🆕 8. **FlightTimeTracker.cs** (增强版飞行时间追踪器)
**功能**: 实时追踪和显示网球飞行时间
- **实时显示**: 🕐 飞行时间实时更新，精确到0.01秒
- **历史记录**: 📊 记录每次飞行时间，显示飞行次数统计
- **详细信息**: 🔧 显示网球高度、速度、距离等调试信息
- **状态监控**: ⚾ 显示网球飞行状态(上升/平飞/下降/落地)
- **统计分析**: 📈 提供平均/最长/最短飞行时间统计

**调试模式特性**:
```csharp
// 调试设置
public bool enableDebugMode = true;      // 启用调试模式
public bool showDetailedInfo = true;     // 显示详细信息
public bool logToConsole = true;         // 输出到控制台

// 追踪设置
public float minTrackingSpeed = 0.3f;    // 最小追踪速度
public float maxTrackingTime = 15f;      // 最大追踪时间
public float minTrackingHeight = -2f;    // 最小追踪高度
```

**UI显示组件**:
- **实时飞行时间**: 🕐 飞行时间: X.XX秒
- **历史记录**: 📊 上次飞行: X.XX秒 (共X次)
- **调试信息**: 🔧 高度: X.XXm | 速度: X.XXm/s | 距离: X.XXm
- **网球状态**: ⚾ 网球状态: 上升阶段 ↗️

**调试控制快捷键**:
- **F10**: 切换调试模式开关
- **F11**: 清空飞行历史记录
- **F12**: 显示详细飞行统计报告

**GUI调试面板**: 右上角显示调试控制面板，包含追踪状态和历史记录信息

### 🔬 辅助脚本系统

#### 测试诊断类 (15个脚本)
- `LauncherDiagnostic.cs` - 发射器诊断
- `ImpactRingDiagnostic.cs` - 撞击标记诊断
- `QuickBallTest.cs` - 快速球体测试
- `UIIntegrationTest.cs` - UI集成测试
- 等多个专用测试脚本

#### UI增强类 (8个脚本)
- `UIStatusMonitor.cs` - 状态监控显示
- `SimpleTennisUI.cs` - 简化UI界面
- `UIDemo.cs` - UI演示系统
- `AutoSetupUIManager.cs` - 自动UI设置

#### 视觉效果类 (12个脚本)
- `TennisCourtLineRenderer.cs` - 场地线条渲染
- `NumberedTargetMarkers.cs` - 编号目标标记
- `ChineseFontFixer.cs` - 中文字体修复
- 等视觉增强脚本

### 🎮 交互控制总览

#### 键盘快捷键
**发射控制**:
- `空格键` - 发射网球
- `Q/E键` - 调整方向(-10°/+10°)

**视角控制**:
- `R键` - 默认视角
- `T键` - 俯视角度
- `F键` - 侧面视角
- `C键` - 近距离观察
- `V键` - 全景视角
- `B键` - 后场视角

**功能切换**:
- `F1键` - 自动播放模式
- `F2键` - 设置面板
- `F3键` - 撞击标记开关
- `F4键` - 清理撞击标记
- `F5键` - 测试撞击标记
- `F6-F9键` - 目标标记控制

**🆕 调试控制**:
- `F10键` - 切换飞行时间调试模式
- `F11键` - 清空飞行历史记录
- `F12键` - 显示飞行统计报告

**移动控制**:
- `WASD键` - 摄像机平移
- `Q/E键` - 摄像机上下移动
- `鼠标右键+拖拽` - 旋转视角
- `鼠标滚轮` - 缩放视距

#### 鼠标交互
- `左键点击` - 发射网球 (非拖拽时)
- `左键拖拽` - 轨迹线拖拽调节
- `右键拖拽` - 旋转摄像机视角

### 📊 系统性能特点

#### 智能优化
- **自动清理**: 防止网球累积影响性能
- **边界检测**: 及时清理异常位置的物体
- **状态缓存**: 避免重复计算和检测
- **分帧处理**: 复杂计算分帧执行

#### 容错机制
- **组件自动查找**: 运行时自动查找和绑定组件
- **异常处理**: 完善的异常检测和处理
- **状态恢复**: 支持参数重置和状态恢复
- **调试信息**: 详细的日志输出便于调试

### 🛠️ 开发扩展性

#### 模块化设计
- **松耦合架构**: 各模块相对独立，便于扩展
- **接口统一**: 统一的组件访问接口
- **配置外置**: 重要参数可在Inspector中调节
- **事件驱动**: 使用事件系统减少直接依赖

#### 自定义扩展
- **新增视角**: 在`CameraController`中添加预设
- **自定义标记**: 扩展标记系统支持新形状
- **物理参数**: 调节空气阻力等物理效果
- **UI主题**: 修改颜色和布局创建新主题

## 最近修复的问题

### Unity MCP Bridge连接错误
**问题**: Unity启动时出现 "Failed to ensure server installation: Error: ConnectFailure" 错误

**原因**: Unity MCP Bridge包尝试连接外部服务器失败，可能是由于：
- 网络连接问题
- 防火墙阻止
- 服务器地址无效

**解决方案**: 已暂时移除 `com.justinpbarnett.unity-mcp` 包以避免连接错误

如需重新启用MCP Bridge功能，请在Packages/manifest.json中添加：
```json
"com.justinpbarnett.unity-mcp": "https://github.com/justinpbarnett/unity-mcp.git?path=/UnityMcpBridge"
```

## 场景视角恢复
如果Unity场景视图角度不合适，可以使用以下方法恢复：

### 🚀 一键视角恢复（推荐）
使用Unity菜单栏中的 `Tools > Scene View` 选项：

1. **最佳俯视角度** (`Tools > Scene View > Best Overview Angle`)
   - 35度俯视角，45度旋转
   - 完美查看整个网球场地和所有元素
   - **这是推荐的最佳视角！**

2. **侧视图** (`Tools > Scene View > Side View`)
   - 90度侧面视角
   - 适合观察网球轨迹和发射路径

3. **正面视图** (`Tools > Scene View > Front View`)
   - 从发射器角度观看
   - 适合调试发射器设置

4. **正上方俯视图** (`Tools > Scene View > Top Down View`)
   - 直接向下俯视
   - 适合查看场地布局

5. **聚焦发射器** (`Tools > Scene View > Focus on Ball Launcher`)
   - 自动聚焦到网球发射器
   - 快速定位关键对象

### 📋 传统方法
1. **快捷键方法**：
   - 选择任意对象（如Main Camera或BallLauncher）
   - 按 `F` 键聚焦到选中对象
   - 使用鼠标滚轮调整缩放

2. **手动调整**：
   - 鼠标中键拖拽：平移视图
   - Alt + 鼠标左键：旋转视图
   - Alt + 鼠标右键：缩放视图

## 使用说明
1. 打开Unity编辑器
2. 加载 `Assets/Scenes/SampleScene.unity` 场景
3. 点击播放按钮开始模拟
4. 使用UI滑块调整发射角度和速度
5. 观察网球轨迹和物理效果
6. **🆕 启用调试模式**: 按F10键切换飞行时间调试信息

### 🎥 摄像机视角控制
游戏运行时，你可以通过以下方式调整视角：

#### 🔤 预设视角（字母键 - 不使用小键盘）
- **R键**：默认视角 - 重置到标准观察角度
- **T键**：俯视角度 - 从上方观察场地 (Top)
- **F键**：侧面视角 - 从侧面观察轨迹 (Front)
- **C键**：近距离观察 - 靠近发射器 (Close)
- **V键**：全景视角 - 观看整个场地 (View)

#### 🎮 实时控制
- **WASD键**：移动摄像机位置
- **Q/E键**：上下移动摄像机
- **鼠标滚轮**：前后缩放
- **右键拖拽**：旋转视角

#### 📱 UI控制
- 使用UI按钮快速切换预设视角
- 调整视野角度滑块改变FOV
- 实时显示摄像机位置信息

### 🆕 飞行时间调试功能
#### 🕐 实时显示
- **飞行时间**: 精确显示当前网球飞行时间
- **历史记录**: 显示上次飞行时间和总次数
- **详细信息**: 显示网球高度、速度、距离
- **状态监控**: 显示网球飞行阶段状态

#### 🔧 调试控制
- **F10**: 切换调试模式开关
- **F11**: 清空所有飞行历史记录
- **F12**: 在控制台显示详细统计报告

#### 📊 统计功能
- 总飞行次数统计
- 平均飞行时间计算
- 最长/最短飞行时间记录
- 总累计飞行时间

## 技术栈
- Unity 2022.3.57f1c2
- C# 脚本
- Unity Physics
- Unity UI系统
- TextMeshPro字体系统

## 维护记录
- 2024-12-19: 修复Unity MCP Bridge连接错误 ✅
- 2024-12-19: 添加场景视角恢复脚本 ✅
- 2024-12-19: 完善项目文档 ✅
- 2024-12-19: 成功测试Unity MCP连接，所有功能正常 ✅
- 2024-12-19: 完成脚本系统全面分析，更新架构文档 ✅
- **🆕 2024-12-19: 启用增强版飞行时间调试模式** ✅
  - ⏱️ 实时飞行时间显示
  - 📊 飞行历史记录和统计
  - 🔧 详细调试信息显示
  - ⚾ 网球状态实时监控
  - 🎮 调试控制快捷键 (F10/F11/F12)
- **🔧 2024-12-19: 修复UI按钮重复发射问题** ✅
  - 🎯 问题描述: 点击"Launch Ball"按钮会连续发射2个网球
  - 🔍 根因分析: FlightTimeTracker脚本重复监听鼠标点击事件
  - ⚡ 解决方案: 移除FlightTimeTracker中的鼠标监听，改为被动检测新球
  - ✅ 修复结果: 现在鼠标点击轨迹和UI按钮都只发射一个网球
- **🔇 2024-12-19: 简化DirectionSlider日志输出** ✅
  - 🎯 问题描述: Unity控制台中大量重复的DirectionSlider状态日志
  - 🔍 根因分析: 多个脚本在每帧或值变化时都输出日志
  - ⚡ 解决方案:
    - UIVisibilityTest: 默认关闭定期日志，只在变化时输出
    - DirectionSliderTest: 默认关闭值变化日志，增加阈值控制
    - BallLauncher: 默认关闭方向日志，只在显著变化时输出
  - ✅ 修复结果: 控制台日志清爽，只显示重要变化信息
- **🔇 2024-12-19: 优化BounceImpactMarker重复日志** ✅
  - 🎯 问题描述: 撞击标记系统每帧输出条件检查日志，造成控制台刷屏
  - 🔍 根因分析: CheckForImpact方法中条件检查日志没有频率控制
  - ⚡ 解决方案:
    - 添加调试开关: enableDetailedLogging/enableConditionLogging (默认关闭)
    - 智能日志控制: 每个球最多每60帧输出一次日志
    - 清理机制: 自动清理已销毁球体的日志记录
    - 状态显示: 在系统状态中显示日志开关状态
  - ✅ 修复结果: 完全消除重复的条件检查日志，控制台清爽
- **🎮 2024-12-19: 修复空格键冲突问题** ✅
  - 🎯 问题描述: 按空格键时出现2个网球，测试脚本与BallLauncher冲突
  - 🔍 根因分析: 3个脚本同时监听空格键事件
    - BallLauncher.cs: 正常发射网球 (Space键)
    - QuickBallTest.cs: 测试发射网球 (Space键) ❌
    - SimpleImpactTest.cs: 创建测试网球 (Space键) ❌
  - ⚡ 解决方案:
    - QuickBallTest: 改为F6键测试发射
    - SimpleImpactTest: 改为F7键创建测试球
    - 保留空格键专用于BallLauncher正常发射
    - 更新所有提示信息和文档
  - ✅ 修复结果: 空格键现在只发射1个网球，测试功能独立
- **🔍 2024-12-19: 修复诊断脚本鼠标冲突** ✅
  - 🎯 问题描述: UI按钮和空格键仍然发射2个网球，诊断脚本也在监听鼠标
  - 🔍 根因分析: LauncherDiagnostic和QuickLauncherFix还在监听鼠标左键
  - ⚡ 解决方案:
    - LauncherDiagnostic: 移除鼠标监听，改为F8键手动检查
    - QuickLauncherFix: 移除鼠标监听，改为F8键手动检查
    - 更新所有诊断脚本的提示信息
    - 确保只有BallLauncher监听空格键和鼠标左键
  - ✅ 修复结果: 现在所有发射方式都只发射1个网球

## 🚀 项目改进建议

### 📈 性能优化方向
1. **对象池管理**: 为网球实现对象池，避免频繁创建销毁
2. **LOD系统**: 为远距离的标记和效果实现细节级别控制
3. **批处理渲染**: 合并标记和轨迹线的渲染调用
4. **异步计算**: 复杂的轨迹计算可移至后台线程

### 🎮 功能扩展方向
1. **多点发射**: 支持同时从多个位置发射网球
2. **风力系统**: 添加风力影响轨迹的物理效果
3. **回合记录**: 记录和回放历史发射数据
4. **成绩统计**: 统计命中率、平均速度等数据

### 🎨 用户体验改进
1. **音效系统**: 添加发射、落地、撞击音效
2. **粒子效果**: 增加发射和撞击的粒子特效
3. **触控支持**: 为移动设备添加触控操作
4. **主题切换**: 支持日间/夜间场景主题

### 🔧 代码质量提升
1. **单元测试**: 为核心算法编写单元测试
2. **配置文件**: 将硬编码参数移至配置文件
3. **本地化**: 支持多语言界面
4. **文档生成**: 使用Doxygen生成API文档

## 🎯 项目总结

### ✨ 项目亮点
- **完整的物理模拟**: 真实的网球物理效果和碰撞检测
- **直观的交互设计**: 支持轨迹拖拽等创新交互方式
- **模块化架构**: 80+脚本组织良好，便于维护和扩展
- **智能系统**: 自动清理、异常处理、容错机制完善
- **丰富的视觉反馈**: 轨迹预测、撞击标记、目标系统
- **🆕 强大的调试功能**: 实时飞行时间追踪和详细统计分析

### 🎓 技术成就
- **高度可配置**: 所有关键参数可在编辑器中调节
- **跨平台兼容**: 支持WebGL等多平台部署
- **性能优化**: 智能清理和边界检测保证稳定运行
- **用户友好**: 详细的快捷键说明和UI指导
- **🆕 调试友好**: 完善的调试模式和统计功能

### 📚 学习价值
这个项目展示了Unity游戏开发的多个重要方面：
- **物理系统运用**: 刚体、碰撞、轨迹计算
- **UI系统设计**: Canvas、滑块、按钮交互
- **摄像机控制**: 多视角切换和实时控制
- **脚本架构**: 模块化设计和组件通信
- **性能管理**: 对象生命周期和资源管理
- **🆕 调试工具**: 实时监控和数据统计

这是一个适合Unity学习者研究的完整项目，涵盖了游戏开发的核心技术栈。

## 故障排除
如遇到其他问题，请检查：
1. Unity版本兼容性
2. 网络连接状态
3. 防火墙设置
4. 项目完整性
5. **🆕 调试模式**: 按F10启用飞行时间调试，按F12查看详细统计